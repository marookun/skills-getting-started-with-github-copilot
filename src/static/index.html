<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mergington High School Activities</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Mergington High School</h1>
      <h2>Extracurricular Activities</h2>
    </header>

    <main>
      <section id="activities-container">
        <h3>Available Activities</h3>
        <div id="activities-list">
          <!-- Loading placeholder replaced by dynamic content rendered via script -->
          <p>Loading activities...</p>
        </div>
      </section>

      <section id="signup-container">
        <h3>Sign Up for an Activity</h3>
        <form id="signup-form">
          <div class="form-group">
            <label for="email">Student Email:</label>
            <input type="email" id="email" required placeholder="your-email@mergington.edu" />
          </div>
          <div class="form-group">
            <label for="activity">Select Activity:</label>
            <select id="activity" required>
              <option value="">-- Select an activity --</option>
              <!-- Activity options will be loaded here -->
            </select>
          </div>
          <button type="submit">Sign Up</button>
        </form>
        <div id="message" class="hidden"></div>
      </section>
    </main>

    <footer>
      <p>&copy; 2023 Mergington High School</p>
    </footer>

    <script src="app.js"></script>
    <!-- Nouveau script : récupère /activities, affiche cartes et participants, et remplit le select -->
    <script>
      (function () {
        const listEl = document.getElementById("activities-list");
        const selectEl = document.getElementById("activity");
        function createParticipantItem(email) {
          const li = document.createElement("li");
          li.className = "participant-item";
          const avatar = document.createElement("span");
          avatar.className = "avatar";
          avatar.textContent = (email && email[0]) ? email[0].toUpperCase() : "?";
          const spanEmail = document.createElement("span");
          spanEmail.className = "participant-email";
          spanEmail.textContent = email;
          li.appendChild(avatar);
          li.appendChild(spanEmail);
          return li;
        }

        function renderActivities(data) {
          // clear
          listEl.innerHTML = "";
          selectEl.innerHTML = '<option value="">-- Select an activity --</option>';

          const entries = Object.entries(data || {});
          if (entries.length === 0) {
            listEl.innerHTML = "<p>Aucune activité disponible.</p>";
            return;
          }

          entries.forEach(([name, info]) => {
            // Card container
            const card = document.createElement("div");
            card.className = "activity-card";

            const h4 = document.createElement("h4");
            h4.textContent = name;
            card.appendChild(h4);

            const desc = document.createElement("p");
            desc.textContent = info.description || "";
            card.appendChild(desc);

            const sched = document.createElement("p");
            sched.innerHTML = "<strong>Schedule:</strong> " + (info.schedule || "—");
            card.appendChild(sched);

            const cap = document.createElement("p");
            const spots = (info.max_participants != null) ? info.max_participants : "—";
            const current = Array.isArray(info.participants) ? info.participants.length : 0;
            cap.innerHTML = "<strong>Capacity:</strong> " + current + " / " + spots;
            card.appendChild(cap);

            // Participants section
            const participantsWrap = document.createElement("div");
            participantsWrap.className = "participants";
            const ph = document.createElement("h5");
            ph.textContent = "Participants";
            participantsWrap.appendChild(ph);

            if (Array.isArray(info.participants) && info.participants.length > 0) {
              const ul = document.createElement("ul");
              info.participants.forEach((e) => {
                ul.appendChild(createParticipantItem(e));
              });
              participantsWrap.appendChild(ul);
            } else {
              const none = document.createElement("div");
              none.className = "no-participants";
              none.textContent = "Aucun participant pour l'instant.";
              participantsWrap.appendChild(none);
            }

            card.appendChild(participantsWrap);

            listEl.appendChild(card);

            // Fill select option
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            selectEl.appendChild(opt);
          });
        }

        // Fetch activities from API
        fetch("/activities")
          .then((r) => {
            if (!r.ok) throw new Error("Network response was not ok");
            return r.json();
          })
          .then((data) => renderActivities(data))
          .catch((err) => {
            console.error(err);
            listEl.innerHTML = "<p class='error'>Impossible de charger les activités.</p>";
          });
      })();
    </script>
  </body>
</html>
